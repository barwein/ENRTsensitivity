% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/pba.R
\name{enrt_pba}
\alias{enrt_pba}
\title{Perform Probabilistic Bias Analysis (PBA) for contamination in ENRT}
\usage{
enrt_pba(
  Y_e,
  Y_a,
  X_e = NULL,
  X_a = NULL,
  Z_e,
  F_a,
  ego_id_a,
  reg_model_egos = NULL,
  reg_model_alters = NULL,
  formula_egos = NULL,
  formula_alters = NULL,
  bootstrap = TRUE,
  B = 1000,
  pz = 0.5,
  probs = c(0.025, 0.975),
  n_cores = 1,
  verbose = TRUE,
  prior_func_ie,
  pi_func_ie,
  pi_args_ie,
  pi_param_name_ie,
  prior_func_de,
  pi_func_de,
  pi_args_de,
  pi_param_name_de,
  ...
)
}
\arguments{
\item{Y_e}{A numeric vector of outcomes for the egos.}

\item{Y_a}{A numeric vector of outcomes for the alters.}

\item{X_e}{A numeric matrix of covariates for the egos.}

\item{X_a}{A numeric matrix of covariates for the alters.}

\item{Z_e}{A binary numeric vector (0 or 1) of treatment assignments for egos.}

\item{F_a}{A binary numeric vector (0 or 1) of `observed` exposures for alters.}

\item{ego_id_a}{A numeric vector mapping each alter to their ego's index.
Indices should correspond to the rows in the ego datasets (Y_e, X_e).}

\item{reg_model_egos}{A function for the egos' outcome regression model, e.g., `glm`.}

\item{reg_model_alters}{A function for the alters' outcome regression model, e.g., `glm`.}

\item{formula_egos}{A formula for the egos' regression model.}

\item{formula_alters}{A formula for the alters' regression model.}

\item{bootstrap}{A logical. If `TRUE` (default), uses the 2D Monte Carlo
(bootstrapping) method. If `FALSE`, uses the normal approximation method.}

\item{B}{An integer specifying the number of Monte Carlo iterations.}

\item{pz}{The known probability of an ego being assigned to treatment, Pr(Z=1).}

\item{probs}{A numeric vector (length=`2`) of probabilities for quantiles.}

\item{n_cores}{Number of cores for parallel execution.}

\item{verbose}{A logical indicating whether to print progress messages.}

\item{prior_func_ie}{A function that returns a single sampled value for the IE
sensitivity parameter (e.g., one 'rho_a' or 'm_a').}

\item{pi_func_ie}{The R function to calculate the IE pi vector (e.g., `pi_homo`).}

\item{pi_args_ie}{A list of all arguments for `pi_func_ie`.}

\item{pi_param_name_ie}{The string name of the argument in `pi_func_ie`.}

\item{prior_func_de}{A function that returns a list with two named elements:
'pi_param' (sampled DE pi parameter) and 'kappa'.}

\item{pi_func_de}{The R function to calculate the DE pi vector (e.g., `pi_homo`).}

\item{pi_args_de}{A list of arguments for `pi_func_de`.}

\item{pi_param_name_de}{The string name of the pi parameter in `pi_func_de`.}

\item{...}{Additional arguments passed to the regression model functions.}
}
\value{
A list containing two data.tables: `IE_results` and `DE_results`.
        Each table provides the mean and quantiles for both the
        'bias_only' and 'total' uncertainty distributions.
}
\description{
This function performs a PBA as described in Section 3.4 of the paper.
It integrates over uncertainty in sensitivity
parameters and sampling uncertainty. It uses a single Monte Carlo loop to
efficiently generate distributions for two types of uncertainty:
1.  **Bias-Only Uncertainty:** Reflects uncertainty from the sensitivity
    parameters, holding the dataset fixed.
2.  **Total Uncertainty:** Reflects both sampling and sensitivity
    parameter uncertainty.

Sampling uncertainty is incorporated in one of two ways, controlled by the
`bootstrap` argument:

* **`bootstrap = TRUE` (default):** Uses a 2D Monte Carlo approach. In each
    iteration, it draws a non-parametric bootstrap sample (resampling
    ego-networks) *and* a sample from the sensitivity parameter priors.

* **`bootstrap = FALSE`:** Uses a Normal Approximation method. In each
    iteration, it draws a sample from the sensitivity parameter priors,
    calculates the bias-corrected point estimate and its empirical variance
    on the *full dataset*, and then draws from the resulting normal
    approximation `N(estimate, variance)` to represent total uncertainty. This
    is computationally faster.
}
\examples{
\dontrun{
# --- 1. Simulate HPTN-037-like data (same as enrt_sa) ---
set.seed(42)
n_e <- 150
n_a <- 263
pz <- 0.5

# (Egos)
X_e <- matrix(rnorm(n_e * 2), n_e, 2, dimnames = list(NULL, c("X1", "X2")))
Z_e <- rbinom(n_e, 1, pz)
Y_e <- rbinom(n_e, 1, 0.3 + 0.1 * Z_e - 0.2 * X_e[,1])

# (Alters)
ego_id_a <- sample(1:n_e, n_a, replace = TRUE)
X_a <- matrix(rnorm(n_a * 2), n_a, 2, dimnames = list(NULL, c("X1", "X2")))
F_a <- Z_e[ego_id_a] # Observed exposure
Y_a <- rbinom(n_a, 1, 0.4 - 0.1 * F_a + 0.1 * X_a[,2])

# --- 2. Define Prior Distributions and Arguments ---

# Priors for IE (Homogeneous m_a, Example 2)
# Use a Poisson(200) prior for m_a
prior_ie_func <- function() {
  round(rpois(1, 200)) # Sample a single m_a value
}

# Arguments for pi_homo (for alters)
pi_args_ie_list <- list(
  n_e = n_e,
  n_a = n_a,
  type = "alter",
  pz = pz
)

# Priors for DE (Homogeneous m_e and kappa)
# Use Poisson(150) for m_e and Uniform(1, 3) for kappa.
prior_de_func <- function() {
  list(
    pi_param = round(rpois(1, 150)), # Sampled m_e
    kappa = runif(1, 1, 3)           # Sampled kappa
  )
}

# Arguments for pi_homo (for egos)
pi_args_de_list <- list(
  n_e = n_e,
  type = "ego",
  pz = pz
)

# --- 3. Run the Probabilistic Bias Analysis ---

# Using augmented estimators (logistic regression)
# and 2D Monte Carlo (bootstrap = TRUE)

pba_results <- enrt_pba(
  Y_e = Y_e, Y_a = Y_a, X_e = X_e, X_a = X_a,
  Z_e = Z_e, F_a = F_a, ego_id_a = ego_id_a,
  reg_model_egos = glm, reg_model_alters = glm,
  formula_egos = Y ~ Z + X1 + X2,
  formula_alters = Y ~ F + X1 + X2,
  bootstrap = TRUE,
  B = 1000, # Recommend 1e3 to 1e4 for full analysis
  pz = pz,
  n_cores = 2, # Use 2 cores
  prior_func_ie = prior_ie_func,
  pi_func_ie = pi_homo,
  pi_args_ie = pi_args_ie_list,
  pi_param_name_ie = "m_vec", # Name of arg to pass sampled value to
  prior_func_de = prior_de_func,
  pi_func_de = pi_homo,
  pi_args_de = pi_args_de_list,
  pi_param_name_de = "m_vec", # Name of arg to pass pi_param to
  family = binomial(link = "logit") # Passed to glm()
)

# View the 95\% intervals for bias-only and total uncertainty
print(pba_results$IE_results)
print(pba_results$DE_results)
}

}
