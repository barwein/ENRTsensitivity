% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/sensitivity_analysis.R
\name{enrt_sa}
\alias{enrt_sa}
\title{Run a Grid Sensitivity Analysis (GSA) for ENRT}
\usage{
enrt_sa(
  Y_e,
  Y_a,
  X_e = NULL,
  X_a = NULL,
  Z_e,
  F_a,
  ego_id_a,
  reg_model_egos = NULL,
  reg_model_alters = NULL,
  formula_egos = NULL,
  formula_alters = NULL,
  pi_lists_ego_ego,
  pi_lists_alter_ego,
  kappa_vec,
  pz = 0.5,
  bootstrap = FALSE,
  B = 1000,
  n_folds = 2,
  n_cores = 1,
  alpha = 0.05,
  plot = TRUE,
  verbose = TRUE,
  ...
)
}
\arguments{
\item{Y_e}{A numeric vector of outcomes for the egos.}

\item{Y_a}{A numeric vector of outcomes for the alters.}

\item{X_e}{A numeric matrix of covariates for the egos.}

\item{X_a}{A numeric matrix of covariates for the alters.}

\item{Z_e}{A binary numeric vector (0 or 1) of treatment assignments for egos.}

\item{F_a}{A binary numeric vector (0 or 1) of `observed` exposures for alters.}

\item{ego_id_a}{A numeric vector mapping each alter to their ego's index.
Indices should correspond to the rows in the ego datasets (Y_e, X_e).}

\item{reg_model_egos}{A function for the egos' outcome regression model, e.g., `glm`.}

\item{reg_model_alters}{A function for the alters' outcome regression model, e.g., `glm`.}

\item{formula_egos}{A formula for the egos' regression model.}

\item{formula_alters}{A formula for the alters' regression model.}

\item{pi_lists_ego_ego}{A named list of lists. Each inner list is a valid
`pi_list_ego_ego` argument.}

\item{pi_lists_alter_ego}{A named list of lists, corresponding to `pi_lists_ego_ego`.}

\item{kappa_vec}{A numeric vector of values for the kappa sensitivity parameter.}

\item{pz}{The known probability of an ego being assigned to treatment, Pr(Z=1).}

\item{bootstrap}{A logical value. If `TRUE`, variance is estimated via
non-parametric bootstrap. If `FALSE` (default), the empirical
(cluster-robust for IE) variance is used.}

\item{B}{An integer specifying the number of bootstrap iterations (if `bootstrap = TRUE`).}

\item{n_folds}{An integer specifying the number of folds for cross-fitting.}

\item{n_cores}{An integer specifying the number of CPU cores to use for
parallel processing.}

\item{alpha}{The significance level for confidence intervals (default 0.05).}

\item{plot}{A logical value. If `TRUE` (default), graphical displays are
generated and returned.}

\item{verbose}{A logical value. If `TRUE` (default), progress messages are
printed to the console.}

\item{...}{Additional arguments passed to the regression model functions (e.g., `family`).}
}
\value{
A list with four elements:
\describe{
  \item{null_results}{A list containing two data.tables (`IE` and `DE`)
        with the naive estimates and CIs.}
  \item{sa_results}{A list containing two data.tables (`IE` and `DE`) with
        the aggregated SA results and CIs.}
  \item{ie_rd_plot}{A ggplot object for the Indirect Effect (RD), or `NULL`.}
  \item{de_rd_plot}{A ggplot object for the Direct Effect (RD), or `NULL`.}
}
}
\description{
This function performs a Grid Sensitivity Analysis (GSA) as described
in Section 3.4 of the paper.
It calculates bias-corrected point estimates, variance, and confidence
intervals for the Indirect Effect (IE) and Direct Effect (DE) over a
user-specified grid of sensitivity parameters.

This is the primary function for GSA. It can use either empirical
variance estimates (fast) or a non-parametric ego-network bootstrap
(more robust).
}
\examples{
\dontrun{
# --- 1. Simulate HPTN-037-like data ---
set.seed(42)
n_e <- 150
n_a <- 263
pz <- 0.5

# (Egos)
X_e <- matrix(rnorm(n_e * 2), n_e, 2, dimnames = list(NULL, c("X1", "X2")))
Z_e <- rbinom(n_e, 1, pz)
Y_e <- rbinom(n_e, 1, 0.3 + 0.1 * Z_e - 0.2 * X_e[,1])

# (Alters)
ego_id_a <- sample(1:n_e, n_a, replace = TRUE)
X_a <- matrix(rnorm(n_a * 2), n_a, 2, dimnames = list(NULL, c("X1", "X2")))
F_a <- Z_e[ego_id_a] # Observed exposure
Y_a <- rbinom(n_a, 1, 0.4 - 0.1 * F_a + 0.1 * X_a[,2])

# --- 2. Define Sensitivity Parameter Grids ---

# Specification 1: Homogeneous (Example 2)
# Grid of m_a values for alters
m_a_grid_homo <- seq(0, 400, by = 50)
pi_list_ae_homo <- pi_homo(m_vec = m_a_grid_homo, n_e = n_e, n_a = n_a,
                           type = "alter", pz = pz)

# Grid of m_e values for egos
m_e_grid_homo <- seq(0, 300, by = 50)
pi_list_ee_homo <- pi_homo(m_vec = m_e_grid_homo, n_e = n_e,
                           type = "ego", pz = pz)

# Specification 2: Heterogeneous (Example 4)
# Use same m grids, but with covariate adjustment
pi_list_ae_hetero <- pi_hetero(X_e = X_e, X_a = X_a, m_vec = m_a_grid_homo,
                               gamma = 1, dist = "norm", p = 2,
                               ego_index = ego_id_a, pz = pz)
pi_list_ee_hetero <- pi_hetero(X_e = X_e, m_vec = m_e_grid_homo, gamma = 1,
                               dist = "norm", p = 2, pz = pz)

# --- 3. Format Parameter Lists for enrt_sa ---

pi_lists_ae <- list(
  Homo = pi_list_ae_homo,
  Hetero = pi_list_ae_hetero
)

pi_lists_ee <- list(
  Homo = pi_list_ee_homo,
  Hetero = pi_list_ee_hetero
)

# Kappa grid for DE
kappa_grid <- seq(1, 3, by = 0.5)

# --- 4. Run the Grid Sensitivity Analysis ---

# Using augmented estimators (logistic regression)
# and empirical variance (bootstrap = FALSE)

sa_results <- enrt_sa(
  Y_e = Y_e, Y_a = Y_a, X_e = X_e, X_a = X_a,
  Z_e = Z_e, F_a = F_a, ego_id_a = ego_id_a,
  reg_model_egos = glm, reg_model_alters = glm,
  formula_egos = Y ~ Z + X1 + X2,
  formula_alters = Y ~ F + X1 + X2,
  pi_lists_ego_ego = pi_lists_ee,
  pi_lists_alter_ego = pi_lists_ae,
  kappa_vec = kappa_grid,
  pz = pz,
  bootstrap = FALSE,
  n_cores = 1,
  family = binomial(link = "logit") # Passed to glm()
)

# View results
print(sa_results$null_results$IE)
print(sa_results$sa_results$IE)

# Show plots
# print(sa_results$ie_rd_plot)
# print(sa_results$de_rd_plot)
}

}
